var socket, client_token, rsakey_prv, rsakey_pub;

function leadingZeros(e, t) {
    var r = "";
    if ((e = e.toString()).length < t)
        for (i = 0; i < t - e.length; i++) r += "0";
    return r + e
}

function getTimeStamp() {
    var e = new Date;
    return leadingZeros(e.getFullYear(), 4) + "-" + leadingZeros(e.getMonth() + 1, 2) + "-" + leadingZeros(e.getDate(), 2) + " " + leadingZeros(e.getHours(), 2) + ":" + leadingZeros(e.getMinutes(), 2) + ":" + leadingZeros(e.getSeconds(), 2)
}

function getCookie(e) {
    for (var t = e + "=", r = decodeURIComponent(document.cookie).split(";"), n = 0; n < r.length; n++) {
        for (var a = r[n];
            " " == a.charAt(0);) a = a.substring(1);
        if (0 == a.indexOf(t)) return a.substring(t.length, a.length)
    }
    return ""
}

function setData(e) {
    console.log(e.data), e.data = JSON.parse(e.data), sessionStorage.setItem(e.txid, JSON.stringify(e)), addTxidList(e.txid)
}

function genRsaKey(t) {
    if (window.Worker) {
        var r = new Worker("js/generate_keypair_worker.js");
        return r.postMessage([0]), r.onmessage = function (e) {
            try {
                e.data ? (setRSAKey(JSON.parse(e.data)), t(null, e)) : t(new Error("Couldn't generate RSA Keypair"))
            } catch (e) {
                console.error(JSON.stringify(e)), t(new Error("Couldn't generate RSA Keypair"))
            } finally {
                r.terminate()
            }
        }
    }
    return window.Promise ? new Promise(function (e, t) {
        try {
            e(KEYUTIL.generateKeypair("RSA", 2048))
        } catch (e) {
            t(e)
        }
    }).then(function (e) {
        return {
            rsakey_pub: KEYUTIL.getJWKFromKey(e.pubKeyObj),
            rsakey_prv: KEYUTIL.getJWKFromKey(e.prvKeyObj)
        }
    }).then(function (e) {
        setRSAKey(e), t(null, e)
    }).catch(function (e) {
        console.error(e)
    }) : setTimeout(function () {
        try {
            rsaKeypair = KEYUTIL.generateKeypair("RSA", 2048), rsaKeypair = {
                rsakey_pub: KEYUTIL.getJWKFromKey(rsaKeyPair.pubKeyObj),
                rsakey_prv: KEYUTIL.getJWKFromKey(rsaKeyPair.prvKeyObj)
            }, setRSAKey(rsaKeypair), t && t(null, rsaKeypair)
        } catch (e) {
            t && t(e)
        }
    }, 0)
}

function setRSAKey(e) {
    sessionStorage.setItem("rsa_prv", JSON.stringify(e.rsakey_prv)), sessionStorage.setItem("rsa_pub", JSON.stringify(e.rsakey_pub))
}

function getRSAKey() {
    var e = sessionStorage.getItem("rsa_pub"),
        t = sessionStorage.getItem("rsa_prv");
    null != e && null != t || genRsaKey();
    var r = JSON.parse(t),
        n = JSON.parse(e);
    rsakey_prv = KEYUTIL.getKey(r), rsakey_pub = KEYUTIL.getKey(n)
}

function getData(e) {
    var t = sessionStorage.getItem(e) || "{}";
    try {
        return JSON.parse(t)
    } catch (e) {
        return console.log(e), {}
    }
}

function addTxidList(e) {
    var t = getTxidList();
    for (var r in t)
        if (t[r] == e) return;
    t.push(e), setTxidList(t)
}

function setTxidList(e) {
    sessionStorage.setItem(client_token, e)
}

function getTxidList() {
    var e = sessionStorage.getItem(client_token);
    if (null == e) {
        setTxidList([]), e = sessionStorage.getItem(client_token)
    }
    var t = e.split(",");
    for (var r in t) "" == t[r] && t.splice(r, 1);
    return t
}

function SHA256(e) {
    function C(e, t) {
        var r = (65535 & e) + (65535 & t);
        return (e >> 16) + (t >> 16) + (r >> 16) << 16 | 65535 & r
    }

    function M(e, t) {
        return e >>> t | e << 32 - t
    }

    function w(e, t) {
        return e >>> t
    }
    return function (e) {
        for (var t = "0123456789abcdef", r = "", n = 0; n < 4 * e.length; n++) r += t.charAt(e[n >> 2] >> 8 * (3 - n % 4) + 4 & 15) + t.charAt(e[n >> 2] >> 8 * (3 - n % 4) & 15);
        return r
    }(function (e, t) {
        var r, n, a, i, s, o, u, g, c, f, y, l, d, h, p, S, K, m, v = new Array(1116352408, 1899447441, 3049323471, 3921009573, 961987163, 1508970993, 2453635748, 2870763221, 3624381080, 310598401, 607225278, 1426881987, 1925078388, 2162078206, 2614888103, 3248222580, 3835390401, 4022224774, 264347078, 604807628, 770255983, 1249150122, 1555081692, 1996064986, 2554220882, 2821834349, 2952996808, 3210313671, 3336571891, 3584528711, 113926993, 338241895, 666307205, 773529912, 1294757372, 1396182291, 1695183700, 1986661051, 2177026350, 2456956037, 2730485921, 2820302411, 3259730800, 3345764771, 3516065817, 3600352804, 4094571909, 275423344, 430227734, 506948616, 659060556, 883997877, 958139571, 1322822218, 1537002063, 1747873779, 1955562222, 2024104815, 2227730452, 2361852424, 2428436474, 2756734187, 3204031479, 3329325298),
            b = new Array(1779033703, 3144134277, 1013904242, 2773480762, 1359893119, 2600822924, 528734635, 1541459225),
            T = new Array(64);
        e[t >> 5] |= 128 << 24 - t % 32, e[15 + (t + 64 >> 9 << 4)] = t;
        for (var A = 0; A < e.length; A += 16) {
            r = b[0], n = b[1], a = b[2], i = b[3], s = b[4], o = b[5], u = b[6], g = b[7];
            for (var k = 0; k < 64; k++) T[k] = k < 16 ? e[k + A] : C(C(C(M(m = T[k - 2], 17) ^ M(m, 19) ^ w(m, 10), T[k - 7]), M(K = T[k - 15], 7) ^ M(K, 18) ^ w(K, 3)), T[k - 16]), c = C(C(C(C(g, M(S = s, 6) ^ M(S, 11) ^ M(S, 25)), (p = s) & o ^ ~p & u), v[k]), T[k]), f = C(M(h = r, 2) ^ M(h, 13) ^ M(h, 22), (y = r) & (l = n) ^ y & (d = a) ^ l & d), g = u, u = o, o = s, s = C(i, c), i = a, a = n, n = r, r = C(c, f);
            b[0] = C(r, b[0]), b[1] = C(n, b[1]), b[2] = C(a, b[2]), b[3] = C(i, b[3]), b[4] = C(s, b[4]), b[5] = C(o, b[5]), b[6] = C(u, b[6]), b[7] = C(g, b[7])
        }
        return b
    }(function (e) {
        for (var t = Array(), r = 0; r < 8 * e.length; r += 8) t[r >> 5] |= (255 & e.charCodeAt(r / 8)) << 24 - r % 32;
        return t
    }(e = function (e) {
        e = e.replace(/\r\n/g, "\n");
        for (var t = "", r = 0; r < e.length; r++) {
            var n = e.charCodeAt(r);
            n < 128 ? t += String.fromCharCode(n) : (127 < n && n < 2048 ? t += String.fromCharCode(n >> 6 | 192) : (t += String.fromCharCode(n >> 12 | 224), t += String.fromCharCode(n >> 6 & 63 | 128)), t += String.fromCharCode(63 & n | 128))
        }
        return t
    }(e)), 8 * e.length))
}

function currentDate(e) {
    e = new Date(e.toString().replace(/GMT.*/, "") + " UTC");
    $("#updateTime").html("업데이트 : " + e.format("yyyy-MM-dd(KS) HH:mm"))
}

function hexToBase64(e) {
    return btoa(String.fromCharCode.apply(null, e.replace(/\r|\n/g, "").replace(/([\da-fA-F]{2}) ?/g, "0x$1 ").replace(/ +$/, "").split(" ")))
}

function base64toHEX(e) {
    var t = window.atob(e),
        r = "";
    for (i = 0; i < t.length; i++) {
        var n = t.charCodeAt(i).toString(16);
        r += 2 == n.length ? n : "0" + n
    }
    return r.toUpperCase()
}

function formatDate(e) {
    if (8 == e.length) return [a = e.substring(0, 4), r = e.substring(4, 6), n = e.substring(6, 8)].join("-");
    if (14 == e.length) return [a = e.substring(0, 4), r = e.substring(7, 9), n = e.substring(12, 14)].join("-");
    var t = new Date(e),
        r = "" + (t.getMonth() + 1),
        n = "" + t.getDate(),
        a = t.getFullYear();
    return r.length < 2 && (r = "0" + r), n.length < 2 && (n = "0" + n), [a, r, n].join("-")
}

function formatDateYYYYMMDDHHMM(e) {
    if (8 == e.length) return [a = e.substring(0, 4), r = e.substring(4, 6), n = e.substring(6, 8)].join("-");
    if (14 == e.length) return [a = e.substring(0, 4), r = e.substring(7, 9), n = e.substring(12, 14)].join("-");
    var t = new Date(e),
        r = "" + (t.getMonth() + 1),
        n = "" + t.getDate(),
        a = t.getFullYear(),
        i = t.getHours(),
        s = t.getMinutes();
    return r.length < 2 && (r = "0" + r), n.length < 2 && (n = "0" + n), [a, r, n].join("-") + " " + pad(i, 2) + ":" + pad(s, 2)
}

function pad(e, t) {
    return (e += "").length >= t ? e : new Array(t - e.length + 1).join("0") + e
}
Date.prototype.format = function (e) {
    if (!this.valueOf()) return " ";
    var t = ["일요일", "월요일", "화요일", "수요일", "목요일", "금요일", "토요일"],
        r = ["일", "월", "화", "수", "목", "금", "토"],
        n = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"],
        a = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"],
        i = this;
    return e.replace(/(yyyy|yy|MM|dd|KS|KL|ES|EL|HH|hh|mm|ss|a\/p)/gi, function (e) {
        switch (e) {
            case "yyyy":
                return i.getFullYear();
            case "yy":
                return (i.getFullYear() % 1e3).zf(2);
            case "MM":
                return (i.getMonth() + 1).zf(2);
            case "dd":
                return i.getDate().zf(2);
            case "KS":
                return r[i.getDay()];
            case "KL":
                return t[i.getDay()];
            case "ES":
                return a[i.getDay()];
            case "EL":
                return n[i.getDay()];
            case "HH":
                return i.getHours().zf(2);
            case "hh":
                return ((h = i.getHours() % 12) ? h : 12).zf(2);
            case "mm":
                return i.getMinutes().zf(2);
            case "ss":
                return i.getSeconds().zf(2);
            case "a/p":
                return i.getHours() < 12 ? "오전" : "오후";
            default:
                return e
        }
    })
}, String.prototype.string = function (e) {
    for (var t = "", r = 0; r++ < e;) t += this;
    return t
}, String.prototype.zf = function (e) {
    return "0".string(e - this.length) + this
}, Number.prototype.zf = function (e) {
    return this.toString().zf(e)
};